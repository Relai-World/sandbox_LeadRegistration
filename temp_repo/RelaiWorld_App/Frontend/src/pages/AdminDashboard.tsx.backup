import React, { useState, useEffect, useMemo } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';
import { LogOut, Search, X, Edit, ChevronsUpDown, Check } from 'lucide-react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { ProjectForm } from '@/components/ProjectForm';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from '@/components/ui/command';
import relaiLogo from '@/assets/relaiLogo.png';
import transLogo1 from '@/assets/transLogo1.png';

// Helper function to conditionally apply class names, similar to `clsx` or `tailwind-merge`
function cn(...inputs: any[]) {
  return inputs.filter(Boolean).join(' ');
}

interface Submission {
  id: string;
  projectName: string;
  agentName: string;
  builderName:string;
  reraNumber: string;
  submittedDate: string;
  status: 'pending' | 'completed';
  formData: any;
  verificationStatus?: 'Verified' | 'Unverified';
  configurations?: any[];
  pricePerSft?: number;
  baseProjectPrice?: number;
}

interface AdminDashboardProps {
  onLogout: () => void;
}

// --- NEW: Reusable Searchable Combobox Component ---
interface SearchableComboboxProps {
  options: { value: string; label: string }[];
  value: string;
  onSelect: (value: string) => void;
  placeholder: string;
}

const SearchableCombobox: React.FC<SearchableComboboxProps> = ({ options, value, onSelect, placeholder }) => {
  const [open, setOpen] = useState(false);
  
  const selectedLabel = options.find(option => option.value === value)?.label || placeholder;

  return (
    <Popover open={open} onOpenChange={setOpen}>
      <PopoverTrigger asChild>
        <Button
          variant="outline"
          role="combobox"
          aria-expanded={open}
          className="w-full sm:w-[200px] justify-between font-normal"
        >
          <span className="truncate">{selectedLabel}</span>
          <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-[200px] p-0">
        <Command>
          <CommandInput placeholder={`Search ${placeholder.toLowerCase()}...`} />
          <CommandList>
            <CommandEmpty>No {placeholder.toLowerCase()} found.</CommandEmpty>
            <CommandGroup>
              <CommandItem
                key="all"
                value="all"
                onSelect={() => {
                  onSelect("all");
                  setOpen(false);
                }}
              >
                <Check className={cn("mr-2 h-4 w-4", value === "all" ? "opacity-100" : "opacity-0")} />
                {placeholder}
              </CommandItem>
              {options.map((option) => (
                <CommandItem
                  key={option.value}
                  value={option.label} // Use label for searching in Command
                  onSelect={() => {
                    onSelect(option.value);
                    setOpen(false);
                  }}
                >
                  <Check className={cn("mr-2 h-4 w-4", value === option.value ? "opacity-100" : "opacity-0")} />
                  {option.label}
                </CommandItem>
              ))}
            </CommandGroup>
          </CommandList>
        </Command>
      </PopoverContent>
    </Popover>
  );
};
// --- END NEW ---

const AdminDashboard: React.FC<AdminDashboardProps> = ({ onLogout }) => {
  const [activeTab, setActiveTab] = useState('verified');
  const [searchTerm, setSearchTerm] = useState('');
  const [submissions, setSubmissions] = useState<Submission[]>([]);
  const [properties, setProperties] = useState<any[]>([]);
  const [statusFilter, setStatusFilter] = useState<'all' | 'pending' | 'completed' | 'verified'>('all');
  const [agentFilter, setAgentFilter] = useState('all');
  const [builderFilter, setBuilderFilter] = useState('all');
  const [projectFilter, setProjectFilter] = useState('all');
  const [selectedSubmission, setSelectedSubmission] = useState<Submission | null>(null);
  const [isViewModalOpen, setIsViewModalOpen] = useState(false);
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  
  // Use environment variable for API base URL
  const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3001';
  
useEffect(() => {
    const fetchSubmissions = async () => {
      try {
        const response = await fetch(`${API_BASE_URL}/api/verified/verified-residential`);
        const result = await response.json();
        if (result.success && result.data && Array.isArray(result.data.verified) && Array.isArray(result.data.unverified)) {
          const mapToSubmission = (item: any, status: 'pending' | 'completed'): Submission => {
            return {
              id: item._id,
              projectName: item.ProjectName,
              agentName: item.POC_Name || item.UserEmail || 'N/A',
              builderName: item.BuilderName,
              reraNumber: item.RERA_Number,
              submittedDate: new Date(item.createdAt).toLocaleDateString(),
              status,
              formData: item,
              verificationStatus: status === 'completed' ? (item.verificationStatus || 'Unverified') : undefined,
              configurations: item.configurations || [],
              pricePerSft: item.Price_per_sft || 0,
              baseProjectPrice: item.BaseProjectPrice || 0,
            };
          };

          const verifiedSubmissions = result.data.verified.map((item: any) => {
            const submission = mapToSubmission(item, 'completed');
            return { ...submission, verificationStatus: (item.verificationStatus || 'Unverified') as 'Verified' | 'Unverified' };
          });
          const unverifiedSubmissions = result.data.unverified.map((item: any) => mapToSubmission(item, 'pending'));
          
          setSubmissions([...unverifiedSubmissions, ...verifiedSubmissions]);
        } else {
          console.error('Failed to fetch submissions or data format is incorrect:', result);
        }
      } catch (error) {
        console.error('Error fetching submissions:', error);
      }
    };

    const fetchProperties = async () => {
      try {
        const response = await fetch(`${API_BASE_URL}/api/verified/all-properties`);
        const result = await response.json();
        if (result.success && Array.isArray(result.data)) {
          console.log(`✅ Fetched ${result.data.length} properties from database`);
          setProperties(result.data);
        } else {
          console.error('Failed to fetch properties or data format is incorrect:', result);
        }
      } catch (error) {
        console.error('Error fetching properties:', error);
      }
    };

    fetchSubmissions();
    fetchProperties();
  }, []);

  const agentNames = useMemo(() => {
    const names = submissions.map(s => s.agentName);
    return [...new Set(names)].filter(Boolean);
  }, [submissions]);

  const builderNames = useMemo(() => {
    const names = submissions.map(s => s.builderName);
    return [...new Set(names)].filter(Boolean);
  }, [submissions]);

  const projectNames = useMemo(() => {
    const names = submissions.map(s => s.projectName);
    return [...new Set(names)].filter(Boolean);
  }, [submissions]);

  // Filter options for properties tab
  const propertyBuilderNames = useMemo(() => {
    const names = properties.map(p => p.BuilderName);
    return [...new Set(names)].filter(Boolean);
  }, [properties]);

  const propertyProjectNames = useMemo(() => {
    const names = properties.map(p => p.ProjectName);
    return [...new Set(names)].filter(Boolean);
  }, [properties]);

  const clearFilters = () => {
    setSearchTerm('');
    setStatusFilter('all');
    setAgentFilter('all');
    setBuilderFilter('all');
    setProjectFilter('all');
  };

  // Reset filters when switching tabs to avoid filter state leaking between tabs
  useEffect(() => {
    clearFilters();
  }, [activeTab]);

  const isAnyFilterActive = searchTerm !== '' || statusFilter !== 'all' || agentFilter !== 'all' || builderFilter !== 'all' || projectFilter !== 'all';

  // Filter properties from properties table
  const filteredProperties = useMemo(() => {
    return properties.filter(property => {
      const lowercasedSearchTerm = searchTerm.toLowerCase();
      const searchMatch = searchTerm === '' ||
        (property.ProjectName || '').toLowerCase().includes(lowercasedSearchTerm) ||
        (property.BuilderName || '').toLowerCase().includes(lowercasedSearchTerm) ||
        (property.RERA_Number || '').toLowerCase().includes(lowercasedSearchTerm);

      const builderMatch = builderFilter === 'all' || property.BuilderName === builderFilter;
      const projectMatch = projectFilter === 'all' || property.ProjectName === projectFilter;

      return searchMatch && builderMatch && projectMatch;
    });
  }, [properties, searchTerm, builderFilter, projectFilter]);

  // All submissions filtered
  const filteredSubmissions = submissions
    .filter(submission => {
      const lowercasedSearchTerm = searchTerm.toLowerCase();
      const searchMatch = searchTerm === '' ||
        (submission.projectName || '').toLowerCase().includes(lowercasedSearchTerm) ||
        (submission.agentName || '').toLowerCase().includes(lowercasedSearchTerm) ||
        (submission.builderName || '').toLowerCase().includes(lowercasedSearchTerm) ||
        (submission.reraNumber || '').toLowerCase().includes(lowercasedSearchTerm);
      
      let statusMatch = false;
      if (statusFilter === 'all') {
        statusMatch = true;
      } else if (statusFilter === 'verified') {
        statusMatch = submission.status === 'completed' && submission.verificationStatus === 'Verified';
      } else {
        statusMatch = submission.status === statusFilter;
      }

      const agentMatch = agentFilter === 'all' || submission.agentName === agentFilter;
      const builderMatch = builderFilter === 'all' || submission.builderName === builderFilter;
      const projectMatch = projectFilter === 'all' || submission.projectName === projectFilter;

      return searchMatch && statusMatch && agentMatch && builderMatch && projectMatch;
    })
    .sort((a, b) => new Date(b.submittedDate).getTime() - new Date(a.submittedDate).getTime());


  const handleVerificationChange = (submissionId: string, newStatus: 'Verified' | 'Unverified') => {
    setSubmissions(currentSubmissions =>
      currentSubmissions.map(sub =>
        sub.id === submissionId
          ? { ...sub, verificationStatus: newStatus }
          : sub
      )
    );
    console.log(`Updated submission ${submissionId} to ${newStatus}`);
  };

  const handleSoldOutChange = async (propertyId: string, newValue: string) => {
    try {
      const response = await fetch(`${API_BASE_URL}/api/verified/property/${propertyId}/sold-out`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ soldOut: newValue }),
      });

      if (!response.ok) {
        throw new Error('Failed to update sold out status');
      }

      // Update local state
      setProperties(currentProperties =>
        currentProperties.map(prop =>
          prop._id === propertyId
            ? { ...prop, soldOut: newValue }
            : prop
        )
      );
      console.log(`Updated property ${propertyId} sold out status to ${newValue}`);
    } catch (error) {
      console.error('Error updating sold out status:', error);
    }
  };

  const transformDataForForm = (apiData: any) => {
    if (!apiData) return {};
    const normalizeUnitType = (unitType: string) => {
      const normalized = unitType.replace(/\s+/g, '');
      const unitTypeMapping: { [key: string]: string } = 
      {
        'Commercial': 'Commercial', 
        'Plotting': 'Plotting', 
        '1 BHK': '1 BHK', 
        '2 BHK': '2 BHK', 
        '2.5BHK': '2.5 BHK',
        '3 BHK': '3 BHK', 
        '3.5 BHK': '3.5 BHK', 
        '4 BHK': '4 BHK', 
        '4.5 BHK': '4.5 BHK', 
        '5 BHK': '5 BHK'
      };  
      return unitTypeMapping[normalized] || normalized;
    };
    const mapApiBuildingTypeToForm = (buildingType: string) => {
      if (buildingType === 'Villas') return 'stand-alone';
      if (buildingType === 'Apartment') return 'gated';
      return buildingType;
    }
    return {
        basics: { projectName: apiData.ProjectName, builderName: apiData.BuilderName, reraNumber: apiData.RERA_Number, projectLocation: apiData.ProjectLocation, buildingName: apiData.BuildingName, projectType: mapApiBuildingTypeToForm(apiData.BuildingType), communityType: apiData.CommunityType, totalLandArea: apiData.Total_land_Area, numberOfTowers: apiData.Number_of_Towers, numberOfFloors: apiData.Number_of_Floors, flatsPerFloor: apiData.Number_of_Flats_Per_Floor, totalUnits: apiData.Total_Number_of_Units, launchDate: apiData.Project_Launch_Date ? new Date(apiData.Project_Launch_Date).toISOString().split('T')[0] : '', possessionDate: apiData.Possession_Date ? new Date(apiData.Possession_Date).toISOString().split('T')[0] : '', constructionStatus: apiData.Construction_Status, openSpace: apiData.Open_Space, },
        construction: { carpetAreaPercentage: apiData.Carpet_area_Percentage, ceilingHeight: apiData.Floor_to_Ceiling_Height, pricePerSft: apiData.Price_per_sft, powerBackup: apiData.PowerBackup, passengerLifts: apiData.No_of_Passenger_lift, serviceLifts: apiData.No_of_Service_lift, visitorParking: apiData.Visitor_Parking, groundVehicleMovement: apiData.Ground_vehicle_Movement, constructionMaterial: apiData.Construction_Material, externalAmenities: apiData.External_Amenities, specifications: apiData.Specification, },
        units: { unitTypes: (() => { const unitTypes: any = {}; const configurations = apiData.configurations || []; configurations.forEach((config: any) => { const unitType = normalizeUnitType(config.type); if (!unitTypes[unitType]) { unitTypes[unitType] = { enabled: true, variants: [] }; } unitTypes[unitType].variants.push({ size: config.sizeRange?.toString() || '', parkingSlots: config.No_of_car_Parking?.toString() || '' }); }); return unitTypes; })(), configurations: apiData.configurations, },
        financial: { baseProjectPrice: apiData.BaseProjectPrice, extraCarParkingAmount: apiData.Amount_For_Extra_Car_Parking, homeLoan: apiData.Home_loan, previousComplaints: apiData.previous_complaints_on_builder, complaintDetails: apiData.complaint_details, },
        secondary: { commissionPercentage: apiData.Commission_percentage, payoutTimePeriod: apiData.After_agreement_of_sale_what_is_payout_time_period, leadRegistrationRequired: apiData.Is_lead_Registration_required_before_Site_visit, leadAcknowledgementTime: apiData.Turnaround_Time_for_Lead_Acknowledgement, validityPeriod: apiData.Is_there_validity_period_for_registered_lead, validityPeriodValue: apiData.validity_period_value, pocName: apiData.POC_Name, pocContact: apiData.POC_Contact, pocRole: apiData.POC_Role, },
    };
  };

  const handleViewSubmission = (submission: Submission) => {
    setSelectedSubmission(submission);
    setIsViewModalOpen(true);
  };

  const handleEditSubmission = (submission: Submission) => {
    setSelectedSubmission(submission);
    setIsEditModalOpen(true);
  };

  const handleUpdateProject = async (updatedApiData: any) => {
    if (!selectedSubmission) return Promise.reject("No submission selected");

    return new Promise(async (resolve, reject) => {
      try {
        const response = await fetch(`${API_BASE_URL}/api/verified/residential/${selectedSubmission.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedApiData),
        });

        if (!response.ok) {
          const errorResult = await response.json();
          throw new Error(errorResult.message || 'Failed to update project');
        }
        const result = await response.json();
        const updatedFormData = result.data;

        setSubmissions(currentSubmissions =>
          currentSubmissions.map(sub =>
            sub.id === selectedSubmission.id
              ? {
                  ...sub,
                  formData: updatedFormData,
                  projectName: updatedFormData.ProjectName,
                  agentName: updatedFormData.POC_Name || updatedFormData.UserEmail || 'N/A',
                  builderName: updatedFormData.BuilderName,
                  reraNumber: updatedFormData.RERA_Number,
                }
              : sub
          )
        );

        setIsEditModalOpen(false);
        setSelectedSubmission(null);
        alert('Project updated successfully!');
        resolve(result);
      } catch (error) {
        console.error('Error updating project:', error);
        alert(`Update failed: ${(error as Error).message}`);
        reject(error);
      }
    });
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed': return 'bg-green-100 text-green-800';
      default: return 'bg-yellow-100 text-yellow-800';
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-white shadow-sm border-b border-gray-200 px-4 lg:px-6 py-3 lg:py-4">
        <div className="flex justify-between items-center"><div className="flex items-center space-x-3"><img src={transLogo1} alt="Relai Logo" className="h-8 w-auto" /><h1 className="text-lg lg:text-xl font-semibold text-gray-800">Admin Dashboard</h1></div><Button onClick={onLogout} variant="outline" size="sm"><LogOut className="w-4 h-4 mr-2" />Logout</Button></div>
      </header>
      <main className="p-4 lg:p-6">
        <div className="max-w-7xl mx-auto space-y-6">
          <div className={`grid grid-cols-1 sm:grid-cols-2 ${activeTab === 'verified' ? 'md:grid-cols-4' : 'md:grid-cols-3'} gap-4`}>
            {activeTab === 'verified' ? (
              <>
                <Card><CardContent className="p-4"><div className="text-center"><div className="text-2xl font-bold text-red-600">{properties.filter(p => p.soldOut === 'yes').length}</div><div className="text-sm text-gray-500">Total Sold Out</div></div></CardContent></Card>
                <Card><CardContent className="p-4"><div className="text-center"><div className="text-2xl font-bold text-blue-600">{properties.filter(p => p.website).length}</div><div className="text-sm text-gray-500">Website Changes</div></div></CardContent></Card>
                <Card><CardContent className="p-4"><div className="text-center"><div className="text-2xl font-bold text-green-600">{properties.filter(p => p.whatsappBot).length}</div><div className="text-sm text-gray-500">WhatsApp Bot Changes</div></div></CardContent></Card>
                <Card><CardContent className="p-4"><div className="text-center"><div className="text-2xl font-bold text-purple-600">{properties.length}</div><div className="text-sm text-gray-500">Total Verified Properties</div></div></CardContent></Card>
              </>
            ) : (
              <>
                <Card onClick={() => setStatusFilter('all')} className={`cursor-pointer ${statusFilter === 'all' ? 'ring-2 ring-purple-600' : ''}`}><CardContent className="p-4"><div className="text-center"><div className="text-2xl font-bold text-gray-900">{submissions.length}</div><div className="text-sm text-gray-500">Total Submissions</div></div></CardContent></Card>
                <Card onClick={() => setStatusFilter('all')} className={`cursor-pointer ${statusFilter === 'all' ? 'ring-2 ring-purple-600' : ''}`}><CardContent className="p-4"><div className="text-center"><div className="text-2xl font-bold text-yellow-600">{submissions.filter(s => s.verificationStatus === 'Unverified').length}</div><div className="text-sm text-gray-500">Unverified</div></div></CardContent></Card>
                <Card onClick={() => setStatusFilter('verified')} className={`cursor-pointer ${statusFilter === 'verified' ? 'ring-2 ring-purple-600' : ''}`}><CardContent className="p-4"><div className="text-center"><div className="text-2xl font-bold text-blue-600">{submissions.filter(s => s.status === 'completed' && s.verificationStatus === 'Verified').length}</div><div className="text-sm text-gray-500">Verified</div></div></CardContent></Card>
              </>
            )}
          </div>
          <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">
            <TabsList className="grid w-full max-w-md grid-cols-2">
              <TabsTrigger value="verified">Verified Properties</TabsTrigger>
              <TabsTrigger value="submissions">Project Submissions</TabsTrigger>
            </TabsList>

            <TabsContent value="verified" className="space-y-4">
              <Card>
                <CardHeader>
                  <CardTitle>Verified Properties</CardTitle>
                  <div className="flex flex-wrap gap-4 items-center mt-4">
                    <div className="relative flex-1 min-w-[250px]"><Search className="absolute left-3 top-3 h-4 w-4 text-gray-400" /><Input placeholder="Search..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="pl-10" /></div>
                    <SearchableCombobox options={propertyBuilderNames.map(name => ({ value: name, label: name }))} value={builderFilter} onSelect={setBuilderFilter} placeholder="All Builders" />
                    <SearchableCombobox options={propertyProjectNames.map(name => ({ value: name, label: name }))} value={projectFilter} onSelect={setProjectFilter} placeholder="All Projects" />
                    {isAnyFilterActive && (<Button variant="ghost" onClick={clearFilters} className="text-purple-600 hover:text-purple-800"><X className="w-4 h-4 mr-2" />Clear Filters</Button>)}
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="overflow-x-auto">
                    <Table>
                      <TableHeader>
                        <TableRow>
                          <TableHead>Project Name</TableHead>
                          <TableHead>Builder</TableHead>
                          <TableHead>RERA Number</TableHead>
                          <TableHead>Configuration</TableHead>
                          <TableHead>Price/Sq ft</TableHead>
                          <TableHead>Base Price</TableHead>
                          <TableHead>Sold Out</TableHead>
                          <TableHead>Website</TableHead>
                          <TableHead>App</TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {filteredProperties.length > 0 ? filteredProperties.map((property) => (
                          <TableRow key={property._id} className="hover:bg-gray-50">
                            <TableCell className="font-medium">{property.ProjectName || 'N/A'}</TableCell>
                            <TableCell>{property.BuilderName || 'N/A'}</TableCell>
                            <TableCell>{property.RERA_Number || 'N/A'}</TableCell>
                            <TableCell className="text-sm max-w-xs">
                              <div className="space-y-2">
                                {property.configurations && property.configurations.length > 0 ? (
                                  property.configurations.map((config: any, index: number) => (
                                    <div key={index} className="pb-2 border-b border-gray-100 last:border-0 last:pb-0">
                                      <div className="font-semibold text-gray-800">{config.type}</div>
                                      <div className="text-xs text-gray-600 space-y-0.5 mt-1">
                                        {(config.sizeSqFt && config.sizeSqYd) && (
                                          <div>Size: {config.sizeSqFt} Sq ft / {config.sizeSqYd} Sq Yd</div>
                                        )}
                                        {(config.sizeRange && !config.sizeSqFt) && (
                                          <div>Size: {config.sizeRange} {config.sizeUnit || 'Sq ft'}</div>
                                        )}
                                        {config.facing && <div>Facing: {config.facing}</div>}
                                        {config.No_of_car_Parking && <div>Parking: {config.No_of_car_Parking} slots</div>}
                                      </div>
                                    </div>
                                  ))
                                ) : (
                                  <span className="text-gray-400">N/A</span>
                                )}
                              </div>
                            </TableCell>
                            <TableCell>₹{property.PriceSheet?.toLocaleString() || 'N/A'}</TableCell>
                            <TableCell>₹{property['Base Project Price']?.toLocaleString() || 'N/A'}</TableCell>
                            <TableCell>
                              <Select 
                                defaultValue={property.soldOut || 'no'} 
                                onValueChange={(value) => handleSoldOutChange(property._id, value)}
                              >
                                <SelectTrigger className="w-[100px]"><SelectValue /></SelectTrigger>
                                <SelectContent>
                                  <SelectItem value="yes">Yes</SelectItem>
                                  <SelectItem value="no">No</SelectItem>
                                </SelectContent>
                              </Select>
                            </TableCell>
                            <TableCell className="max-w-[150px]">
                              {property.website ? (
                                <a href={property.website} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline truncate block">
                                  {property.website}
                                </a>
                              ) : 'N/A'}
                            </TableCell>
                            <TableCell className="max-w-[150px]">
                              {property.app ? (
                                <a href={property.app} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline truncate block">
                                  {property.app}
                                </a>
                              ) : 'N/A'}
                            </TableCell>
                          </TableRow>
                        )) : (
                          <TableRow>
                            <TableCell colSpan={9} className="text-center h-24">No verified properties found.</TableCell>
                          </TableRow>
                        )}
                      </TableBody>
                    </Table>
                  </div>
                </CardContent>
              </Card>
            </TabsContent>

            <TabsContent value="submissions" className="space-y-4">
              <Card>
                <CardHeader>
                  <CardTitle>Project Submissions</CardTitle>
                  <div className="flex flex-wrap gap-4 items-center mt-4">
                    <div className="relative flex-1 min-w-[250px]"><Search className="absolute left-3 top-3 h-4 w-4 text-gray-400" /><Input placeholder="Search..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="pl-10" /></div>
                    <Select value={statusFilter} onValueChange={(value) => setStatusFilter(value as any)}>
                      <SelectTrigger className="w-full sm:w-[180px]"><SelectValue placeholder="Filter by Status" /></SelectTrigger>
                      <SelectContent><SelectItem value="all">All Statuses</SelectItem><SelectItem value="pending">Pending</SelectItem><SelectItem value="completed">Completed</SelectItem><SelectItem value="verified">Verified</SelectItem></SelectContent>
                    </Select>
                    <SearchableCombobox options={agentNames.map(name => ({ value: name, label: name }))} value={agentFilter} onSelect={setAgentFilter} placeholder="All Agents" />
                    <SearchableCombobox options={builderNames.map(name => ({ value: name, label: name }))} value={builderFilter} onSelect={setBuilderFilter} placeholder="All Builders" />
                    <SearchableCombobox options={projectNames.map(name => ({ value: name, label: name }))} value={projectFilter} onSelect={setProjectFilter} placeholder="All Projects" />
                    {isAnyFilterActive && (<Button variant="ghost" onClick={clearFilters} className="text-purple-600 hover:text-purple-800"><X className="w-4 h-4 mr-2" />Clear Filters</Button>)}
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="overflow-x-auto">
                    <Table>
                      <TableHeader>
                        <TableRow>
                          <TableHead>Project Name</TableHead>
                          <TableHead>Builder</TableHead>
                          <TableHead>RERA Number</TableHead>
                          <TableHead>Configuration</TableHead>
                          <TableHead>Price/Sq ft</TableHead>
                          <TableHead>Base Price</TableHead>
                          <TableHead>Status</TableHead>
                          <TableHead>Verification</TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {filteredSubmissions.length > 0 ? filteredSubmissions.map((submission) => (
                          <TableRow key={submission.id} className="hover:bg-gray-50">
                            <TableCell className="font-medium">{submission.projectName}</TableCell>
                            <TableCell>{submission.builderName}</TableCell>
                            <TableCell>{submission.reraNumber}</TableCell>
                            <TableCell className="text-sm max-w-xs">
                              <div className="space-y-2">
                                {submission.configurations && submission.configurations.length > 0 ? (
                                  submission.configurations.map((config: any, index: number) => (
                                    <div key={index} className="pb-2 border-b border-gray-100 last:border-0 last:pb-0">
                                      <div className="font-semibold text-gray-800">{config.type}</div>
                                      <div className="text-xs text-gray-600 space-y-0.5 mt-1">
                                        {(config.sizeSqFt && config.sizeSqYd) && (
                                          <div>Size: {config.sizeSqFt} Sq ft / {config.sizeSqYd} Sq Yd</div>
                                        )}
                                        {(config.sizeRange && !config.sizeSqFt) && (
                                          <div>Size: {config.sizeRange} {config.sizeUnit || 'Sq ft'}</div>
                                        )}
                                        {config.facing && <div>Facing: {config.facing}</div>}
                                        {config.No_of_car_Parking && <div>Parking: {config.No_of_car_Parking} slots</div>}
                                      </div>
                                    </div>
                                  ))
                                ) : (
                                  <span className="text-gray-400">N/A</span>
                                )}
                              </div>
                            </TableCell>
                            <TableCell>₹{submission.pricePerSft?.toLocaleString() || 'N/A'}</TableCell>
                            <TableCell>₹{submission.baseProjectPrice?.toLocaleString() || 'N/A'}</TableCell>
                            <TableCell><Badge className={getStatusColor(submission.status)}>{submission.status}</Badge></TableCell>
                            <TableCell>
                              <Select 
                                value={submission.verificationStatus || 'Unverified'} 
                                onValueChange={(value: 'Verified' | 'Unverified') => handleVerificationChange(submission.id, value)}
                                disabled={submission.status === 'pending'}
                              >
                                <SelectTrigger className="w-[120px]"><SelectValue placeholder="Set Status" /></SelectTrigger>
                                <SelectContent><SelectItem value="Unverified">Unverified</SelectItem><SelectItem value="Verified">Verified</SelectItem></SelectContent>
                              </Select>
                            </TableCell>
                          </TableRow>
                        )) : (
                          <TableRow>
                            <TableCell colSpan={8} className="text-center h-24">No submissions match your criteria.</TableCell>
                          </TableRow>
                        )}
                      </TableBody>
                    </Table>
                  </div>
                </CardContent>
              </Card>
            </TabsContent>
          </Tabs>
        </div>
      </main>
      <Dialog open={isViewModalOpen} onOpenChange={setIsViewModalOpen}>
        <DialogContent className="max-w-6xl max-h-[90vh] overflow-auto"><DialogHeader><DialogTitle>Project Details</DialogTitle><DialogDescription>Viewing the details of the submitted project.</DialogDescription></DialogHeader>
          {selectedSubmission && (<div className="p-4"><div className="mb-4 p-3 bg-blue-50 rounded-lg"><p className="text-sm text-blue-700"><strong>Agent:</strong> {selectedSubmission.agentName} | <strong> Submitted:</strong> {selectedSubmission.submittedDate}</p></div><ProjectForm initialData={transformDataForForm(selectedSubmission.formData)} isViewMode={true} /></div>)}
        </DialogContent>
      </Dialog>
      <Dialog open={isEditModalOpen} onOpenChange={setIsEditModalOpen}>
        <DialogContent className="max-w-6xl max-h-[90vh] overflow-auto">
          <DialogHeader><DialogTitle>Edit Project Details</DialogTitle><DialogDescription>Modifying project: {selectedSubmission?.projectName}</DialogDescription></DialogHeader>
          {selectedSubmission && (<ProjectForm initialData={transformDataForForm(selectedSubmission.formData)} isViewMode={false} />)}
        </DialogContent>
      </Dialog>
    </div>
  );
};

export default AdminDashboard;